def FAILED_STAGE
def allJob = env.JOB_NAME.tokenize('/') as String[];
def projectName = allJob[1];
pipeline {
	agent any
	stages {
		stage('Build') {
			steps {
				script {
					FAILED_STAGE=env.STAGE_NAME
					echo "Testing ${env.STAGE_NAME}"
				}
			}
		}
		stage('Test'){
			steps {
				script {
					FAILED_STAGE=env.STAGE_NAME
					echo "Testing ${env.STAGE_NAME}"
					error("Build failed because of this and that..")
				}
			}
		}
		stage('Deploy') {
			steps {
				script {
					FAILED_STAGE=env.STAGE_NAME
					echo "Testing ${env.STAGE_NAME}"
				}
			}
		}
	}
	post {
		failure {
			mail to: 'sd.gcp.ae@gmail.com',
            		subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
             		body: "Something is wrong with the ${projectName}-${env.GIT_BRANCH}-Branch-BuildNumber-${env.BUILD_NUMBER} in the ${env.STAGE_NAME} stage.
			Build URL: ${env.BUILD_URL}"
		}
		success {
			echo 'I am sending a notification with success'
		}
	}
}
